<!doctype html><html class=no-js lang=jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>VST3開発TIPS テスト編 - log</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><meta property="og:title" content="VST3開発TIPS テスト編"><meta property="og:description" content="前回に引き続きCUIでVST3開発をすすめています。いくつか役立ちそうなTIPS+、とくにテスト関連をメモしています。適宜追加するかもしれま"><meta property="og:type" content="article"><meta property="og:url" content="https://shigekikarita.github.io/log/posts/vst3-test-tips/"><meta property="article:published_time" content="2020-01-13T16:53:29+09:00"><meta property="article:modified_time" content="2020-01-13T16:53:29+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="VST3開発TIPS テスト編"><meta name=twitter:description content="前回に引き続きCUIでVST3開発をすすめています。いくつか役立ちそうなTIPS+、とくにテスト関連をメモしています。適宜追加するかもしれま"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/log/css/style.css><link rel=stylesheet href=/log/css/custom.css><link rel="shortcut icon" href=/log/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-139201189-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a class=logo__link href=/log/ title=log rel=home><div class=logo__title>log</div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=https://shigekikarita.github.io>home</a></li><li class=menu__item><a class=menu__link href=https://github.com/ShigekiKarita/log>github</a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>VST3開発TIPS テスト編</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-01-13T16:53:29>2020-01-13</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/log/categories/vst3 rel=category>VST3</a>, <a class=meta__link href=/log/categories/c++ rel=category>C++</a></span></div></div></header><div class="content post__content clearfix"><p>前回に引き続きCUIでVST3開発をすすめています。いくつか役立ちそうなTIPS+、とくにテスト関連をメモしています。適宜追加するかもしれません。</p><h2 id=1-情報源>1. 情報源</h2><ul><li><a href=https://steinbergmedia.github.io/vst3_doc/>公式ドキュメント</a>、Doxgen検索機能やリンクが割と貧弱なのでローカルでgrepすることが多いです</li><li><a href="https://vstcpp.wpblog.jp/?page_id=1316">はじめてのVST3.6プラグイン作り</a>、公式に殆どない(リンク切れてるし&mldr;)GUI関連の情報が嬉しいです</li></ul><h2 id=2-テスト用のvstホスト>2. テスト用のVSTホスト</h2><p>まずVSTプラグインをつくったら、動かすにはホストが必要です。最終的には普段使っているDAWなりで検証すると思いますが、高速な開発サイクルを回すには軽量なテスト用ホストを使うと便利です。</p><h3 id=公式-コマンドラインvalidator>公式 コマンドラインvalidator</h3><p>4つあるSDK付属ホストの一つ。<a href=https://steinbergmedia.github.io/vst3_doc/vstinterfaces/cmakeUse.html>公式に沿って <code>SMTG_ADD_VST3_HOSTING_SAMPLES=ON</code> で cmakeビルド</a>するとbin/Debug以下にできているはず</p><ul><li><a href=https://github.com/steinbergmedia/vst3_public_sdk/tree/master/samples/vst-hosting>ソースコード</a></li><li><a href=https://steinbergmedia.github.io/vst3_doc/vstsdk/applications.html>ドキュメント</a></li></ul><p>GUIは起動しないので、お手軽な感じです。実はテストランナーも備えていて、以下の公式例のように書くと呼んでくれます。ちょっと記述量が多めですが。</p><ul><li><a href=https://github.com/steinbergmedia/vst3_public_sdk/blob/master/samples/vst/adelay/source/factory.cpp#L72>ITestを継承するテスト宣言</a>、Factoryは<a href=https://github.com/steinbergmedia/vst3_public_sdk/blob/master/samples/vst/adelay/source/factory.cpp#L72>factory.cppで登録するため</a></li><li><a href=https://github.com/steinbergmedia/vst3_public_sdk/blob/master/samples/vst/adelay/source/factory.cpp#L72>テスト実装</a>、リソース確保などなければrunメソッドのみ。階層的にITestを登録したければFactoryのcreateTestsで登録できる</li></ul><p>現実的にはこちらはEnd-to-endテスト用と割り切って、VSTに依存しない処理はGoogleTestなりなにか自分の好きなフレームワークを専用のmain関数をもつ実行ファイルから呼ぶだろうと思います</p><h3 id=公式-editorhost>公式 editorhost</h3><p>あまり何に使うのかわかっていません。</p><h3 id=公式-audiohost>公式 audiohost</h3><p>JACKが必要なのでWindowsでは試してないけど、あまり選択肢がないLinuxでは便利かもしれないです。</p><h3 id=公式-vst3plugintesthost>公式 VST3PluginTestHost</h3><p><img src=/log/img/vsthost.png alt=host></p><p><code>VST_SDK\VST3_SDK\bin\Windows 64 bit\VST3PluginTestHost_x64_Installer_2.8.0.zip</code>にあるインストーラで動く。若干起動が遅いのであまり使っていないですが、VST GUIエディタを使うときなど安定しているので便利そうです。Linux向けはないようです。</p><h3 id=juce-audiopluginhost>JUCE AudioPluginHost</h3><p>validatorの次くらいによく使っているやつです。Win/Mac/Linuxサポートされています。</p><p><a href=https://github.com/WeAreROLI/JUCE/tree/master/extras/AudioPluginHost>https://github.com/WeAreROLI/JUCE/tree/master/extras/AudioPluginHost</a></p><p>JUCEはオープンソースのプラグイン開発ツールキットです、Steinberg公式よりも情報や機能が多い。これも軽くて楽です。前回のプロジェクトがプラグイン開きっぱなしの状態で開くので、開発中に一発でGUI動作確認できます。MIDI Outがないのが不満ですが&mldr;GPLのオープンソースなので改造してみました<a href=https://github.com/WeAreROLI/JUCE/pull/656>(PRも送っています)</a>。</p><p>Visual Studio2019でビルドする場合はファイル<code>extras/AudioPluginHost/Builds/VisualStudio2019/AudioPluginHost.sln</code>をVSで開いて、上メニューバーの「ビルド＞ソリューションのビルド」で一発です。終われば<code>JUCE\extras\AudioPluginHost\Builds\VisualStudio2019\x64\Debug\App</code>以下に実行ファイルができている筈です。</p><h2 id=3-debugprint-系の使い方>3. DebugPrint 系の使い方</h2><p><code>#include "base/source/fdebug.h"</code>で使える、<code>SMTG_WARNING</code>, <code>SMTG_DBPRT0</code> .. <code>SMTG_DBPRT5</code>系の関数はprintf的なノリで使えます</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;base/source/fdebug.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>foo</span>()
{
	SMTG_ASSERT(<span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span>);
	SMTG_WARNING(<span style=color:#e6db74>&#34;invalid input!&#34;</span>);
	SMTG_DBPRT1(<span style=color:#e6db74>&#34;%s is not found&#34;</span>, path);
	<span style=color:#75715e>// VERIFY系はReleaseのとき評価だけされるので注意、エラーはでない
</span><span style=color:#75715e></span>	SMTG_VERIFY(<span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span>);
}
</code></pre></div><p>cmakeに <code>-DCMAKE_BUILD_TYPE=Debug</code> オプションを渡すと有効になり、<code>=Release</code>のとき無効になります。これがどこに表示されるのかよくわかっていないのですが、WindowsであればVisual StudioまたはgdbでVSTホストなりを起動してみるとどこかに表示されます。</p><p>例: <code>$ gdb AudioPluginHost.exe</code></p><p>仕組みは <code>gDebugPrintLogger</code> という文字列を出力する関数ポインタを実行時にセットして呼ぶようです。デバッガの起動がだるいときはVST内で無理やりprintfなどに書き換えれば、標準出力にだしてコンソールからホストを起動していれば見れます。</p><h2 id=4-cによるファイルパス操作>4. C++によるファイルパス操作</h2><p>これはテストとは少し違いますが、テストでファイルを扱うことは多々あるのでメモ。VSTではなんだかUTF8/16などが混在しているようですが、C++17で標準になったfilesystemを使うと<code>std::filesystem::path::string</code>や<code>std::filesystem::u16string</code>など多機能なエンコードでファイルパスを扱えますし、OSの提供するAPIに依存せずにマルチOS対応できて良いです。ちなみにC++11のUTF8や16を変換する<code>&lt;codecvt></code>は非推奨になったので使ってはいけません。</p><p>C++17を有効にするには、プラグインのCMakeLists.txtに以下を追記するようです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake>set_property(<span style=color:#e6db74>TARGET</span> <span style=color:#f92672>${</span>target<span style=color:#f92672>}</span> <span style=color:#e6db74>PROPERTY</span> <span style=color:#e6db74>CXX_STANDARD</span> <span style=color:#e6db74>17</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set_property(<span style=color:#e6db74>TARGET</span> <span style=color:#f92672>${</span>target<span style=color:#f92672>}</span> <span style=color:#e6db74>PROPERTY</span> <span style=color:#e6db74>CXX_STANDARD_REQUIRED</span> <span style=color:#e6db74>ON</span>)<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>ちなみにfilesystemの日本語解説、こちらが素晴らしいです。 <a href=https://cpprefjp.github.io/reference/filesystem.html>https://cpprefjp.github.io/reference/filesystem.html</a></p></div><div class="post__tags tags clearfix"><svg class="tags__icon icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/log/tags/vst3/ rel=tag>VST3</a></li><li class=tags__item><a class="tags__link btn" href=/log/tags/c++/ rel=tag>C++</a></li></ul></div></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Shigeki Karita avatar" src=/log/img/avatar.jpg class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Shigeki Karita</span></div><div class=authorbox__description>D言語と日々の研究について雑記</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=/log/posts/vst3-hello/ rel=prev><span class=post-nav__caption>«&#8201;Previous</span><p class=post-nav__post-title>Windows CUI環境における VST3 開発</p></a></div><div class="post-nav__item post-nav__item--next"><a class=post-nav__link href=/log/posts/linux-setup-2020/ rel=next><span class=post-nav__caption>Next&#8201;»</span><p class=post-nav__post-title>2020年Linux開発マシン設定: btrfsに乗り換え</p></a></div></nav></div></div><script type=text/x-mathjax-config>
 MathJax.Hub.Config({
     tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
     TeX: { equationNumbers: {autoNumber: "AMS"} }
 });
 MathJax.Hub.Config({
     tex2jax: {
         inlineMath: [['$','$'], ['\\(','\\)']],
         displayMath: [['$$','$$'], ['\[','\]']],
         processEscapes: true,
         processEnvironments: true,
         skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
         TeX: { equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js"] }
     }
 });

</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-6633457078111023",enable_page_level_ads:true});</script></div><script async defer src=/log/js/menu.js></script></body></html>