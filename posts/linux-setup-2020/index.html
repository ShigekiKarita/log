<!doctype html><html class=no-js lang=jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>2020年Linux開発マシン設定: btrfsに乗り換え - log</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><meta property="og:title" content="2020年Linux開発マシン設定: btrfsに乗り換え"><meta property="og:description" content="Thinkpad X1 Extreme Gen2 年末に新しいマシン(Thinkpad X1 Extreme Gen2)買いました。そのセットアップなどの自分用メモです。 X1 Extremeのすごいところ:"><meta property="og:type" content="article"><meta property="og:url" content="https://shigekikarita.github.io/log/posts/linux-setup-2020/"><meta property="article:published_time" content="2020-03-29T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-29T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="2020年Linux開発マシン設定: btrfsに乗り換え"><meta name=twitter:description content="Thinkpad X1 Extreme Gen2 年末に新しいマシン(Thinkpad X1 Extreme Gen2)買いました。そのセットアップなどの自分用メモです。 X1 Extremeのすごいところ:"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/log/css/custom.css><link rel="shortcut icon" href=/log/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-139201189-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a class=logo__link href=/log/ title=log rel=home><div class=logo__title>log</div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1></span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=https://shigekikarita.github.io>home</a></li><li class=menu__item><a class=menu__link href=https://github.com/ShigekiKarita/log>github</a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>2020年Linux開発マシン設定: btrfsに乗り換え</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-03-29T00:00:00>2020-03-29</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/log/categories/linux rel=category>Linux</a></span></div></div></header><div class="post__toc toc"><div class=toc__title></div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#headline-1>Thinkpad X1 Extreme Gen2</a></li><li><a href=#headline-2>2つのNVMe</a></li><li><a href=#headline-3>ext4からbtrfsに乗り換え</a></li><li><a href=#headline-4>btrfs の snapshot 機能</a><ul><li><a href=#headline-5>subvolume という概念</a></li><li><a href=#headline-6>snapshot の復元</a></li></ul></li><li><a href=#headline-7>起動が遅いとき</a></li><li><a href=#headline-8>Linux上のVBoxからWindows 10起動</a></li><li><a href=#headline-9>おわりに</a></li></ul></nav></div></div><div class="content post__content clearfix"><h3 id=headline-1>Thinkpad X1 Extreme Gen2</h3><p>年末に新しいマシン(Thinkpad X1 Extreme Gen2)買いました。そのセットアップなどの自分用メモです。</p><p><img src=./x1x.jpg alt=./x1x.jpg title=./x1x.jpg></p><p>X1 Extremeのすごいところ:</p><ul><li><p>1.7kgとMacbook Proとかより軽い</p></li><li><p>しっかり幅と深さのあるキーボードの打ち心地</p></li><li><p>NVIDIAのGPUが載ってるが、バッテリは連続作業で約4時間とゲーミングよりは良い</p></li><li><p>USB Cの電源(65W)も使える、さすがに標準の専用アダプタよりは遅いが便利</p></li><li><p>メモリ(DDR4が2スロット)とストレージ(NVMeが2スロット)が増設可能</p></li></ul><p>私は最小構成(1スロット分ずつ)で発注して、届いてすぐ増設しました。ちなみに公式サイトよりもヨドバシカメラ(おそらく店頭販売のみ)の方が安いです。</p><h3 id=headline-2>2つのNVMe</h3><p>折角2スロットあるので、もともとあったWindows 10ストレージを1TBの増設NVMeに<a href="https://clonezilla.org/show-live-doc-content.php?topic=clonezilla-live/doc/03_Disk_to_disk_clone">Clonezillaのdisk-to-disk clone</a>で移して、既存の小さいNVMeにUbuntuを入れました。ちなみに最初はWindows上で動くプロプライエタリソフトウェアを使ったのですが、遅いしGPT破損が避けられず全然うまく行きませんでした。とりあえずこの三点を守れば今後は大丈夫かと:</p><ul><li><p>Clonezilla の Live USB を使う</p></li><li><p>Secure boot をオフ</p></li><li><p><a href=https://xtech.nikkei.com/atcl/nxt/column/18/00968/091300001/>高速スタートアップ</a>をオフ</p></li></ul><h3 id=headline-3>ext4からbtrfsに乗り換え</h3><p>今までUbuntuでデフォルトのext4を使っていたのですが、<a href=https://gihyo.jp/book/2018/978-4-7741-9607-7>Linuxのしくみ</a>という本を読んで面白そうと思ったbtrfsを使おうと思いました。効率的に重複や読み書きをスキップするスナップショットやコピーオンライトといった技術でいうとzfsもいいなと思ったのですが、Linux上でのドキュメントやツールの充実具合から選びました。</p><p>基本的にUbuntuインストーラ上でbtrfsを設定しただけですが、あとから <code>/etc/fstab</code> でSSD用と圧縮オプション <code>ssd,compress=lzo</code> を追加しました。</p><div class="src src-bash"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># /etc/fstab: static file system information.</span>
<span style=color:#75715e># Use &#39;blkid&#39; to print the universally unique identifier for a</span>
<span style=color:#75715e># device; this may be used with UUID= as a more robust way to name devices</span>
<span style=color:#75715e># that works even if disks are added and removed. See fstab(5).</span>
<span style=color:#75715e># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
<span style=color:#75715e># / was on /dev/nvme1n1p2 during installation</span>
UUID<span style=color:#f92672>=</span>e690b30f-52aa-4bf2-828a-85de64431456 /               btrfs   noatime,discard,ssd,compress<span style=color:#f92672>=</span>lzo,space_cache,subvol<span style=color:#f92672>=</span>@ <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>1</span>
<span style=color:#75715e># /boot/efi was on /dev/nvme0n1p1 during installation</span>
UUID<span style=color:#f92672>=</span>3E93-4FA7  /boot/efi       vfat    umask<span style=color:#f92672>=</span><span style=color:#ae81ff>0077</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>1</span>
<span style=color:#75715e># /home was on /dev/nvme1n1p2 during installation</span>
UUID<span style=color:#f92672>=</span>e690b30f-52aa-4bf2-828a-85de64431456 /home           btrfs   noatime,discard,ssd,compress<span style=color:#f92672>=</span>lzo,space_cache,subvol<span style=color:#f92672>=</span>@home <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>2</span>
<span style=color:#75715e># swap was on /dev/nvme1n1p4 during installation</span>
UUID<span style=color:#f92672>=</span>1a95e0ca-44c4-497c-b34e-7a7516d1790d none            swap    sw              <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span></code></pre></div></div><h3 id=headline-4>btrfs の snapshot 機能</h3><p>とりあえず最初にTwitter上で見てbtrfsをためそうと思ったきっかけのブログ記事「<a href=https://www.ncaq.net/2019/01/28/13/37/05/>デスクトップLinuxにBtrfsとSnapperを使うようになってファイルを間違えて削除してしまう恐怖から開放されました</a>」を見ながら、snapperを導入しました。初心者すぎてよくわからなかったことをメモします。多くの方は私のいい加減なブログではなく<a href=https://wiki.archlinux.jp/index.php/Btrfs>Arch Wiki</a>をまず見てください。</p><h4 id=headline-5>subvolume という概念</h4><p>まだ慣れていないのですが、多くのファイルシステムの物理的なボリュームと、OS上のディレクトリの間くらいの概念で、柔軟にディレクトリごとのマウントオプションやスナップショットを設定できます。たとえばスナップショット自体も独立したsubvolumeに切られたりしてます。新たに作ったり、一覧表示するにはbtrfsコマンドを使います。</p><div class="src src-bash"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo btrfs subvolume list -p .</code></pre></div></div><p>私の方針は基本的には <code>/home</code> subvolume は全部自動スナップショットとることにして、明らかにバックアップがいらない <code>.pip</code> だとか <code>.dub</code> のようなキャッシュ的なディレクトリ、大きめの3rdパーティソフトを新しくsubvolumeに切って除外しています(デフォルトではスナップショットされないので)。他にはarch wikiにあるようにpacmanやaptといったシステムのパッケージマネージャの履歴を保存する使い方も良いです。</p><div class="src src-text"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ sudo snapper get-config
Key                    | Value
-----------------------+------
ALLOW_GROUPS           |      
ALLOW_USERS            |      
BACKGROUND_COMPARISON  | yes  
EMPTY_PRE_POST_CLEANUP | yes  
EMPTY_PRE_POST_MIN_AGE | 1800 
FSTYPE                 | btrfs
NUMBER_CLEANUP         | yes  
NUMBER_LIMIT           | 50   
NUMBER_LIMIT_IMPORTANT | 10   
NUMBER_MIN_AGE         | 1800 
QGROUP                 |      
SPACE_LIMIT            | 0.5  
SUBVOLUME              | /home
SYNC_ACL               | no   
TIMELINE_CLEANUP       | yes  
TIMELINE_CREATE        | yes  
TIMELINE_LIMIT_DAILY   | 10   
TIMELINE_LIMIT_HOURLY  | 10   
TIMELINE_LIMIT_MONTHLY | 10   
TIMELINE_LIMIT_WEEKLY  | 0    
TIMELINE_LIMIT_YEARLY  | 10   
TIMELINE_MIN_AGE       | 1800</code></pre></div></div><h4 id=headline-6>snapshot の復元</h4><p>snapshotを取る方法はよく書かれているのですが、どうやってそこから復元するのか、正直よくわかってませんでした。たとえば上記の設定で <code>/home/karita</code> 以下に作った <code>foo</code> ファイルを消したときには、こうやって拾えます</p><div class="src src-bash"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cd /home/karita
$ touch foo
$ sudo snapper create --description test <span style=color:#75715e># 手動でsnapshot</span>
$ sudo snapper list  <span style=color:#75715e># test ができてる</span>
Type   | <span style=color:#75715e>#   | Pre # | Date                        | User | Cleanup  | Description | Userdata</span>
-------+-----+-------+-----------------------------+------+----------+-------------+---------
single | <span style=color:#ae81ff>0</span>   |       |                             | root |          | current     |         
single | <span style=color:#ae81ff>1</span>   |       | Sun Dec <span style=color:#ae81ff>29</span> 17:27:39 <span style=color:#ae81ff>2019</span>    | root |          | test        | 

$ rm foo   <span style=color:#75715e># 消してみる</span>
$ sudo ls ../.snapshots/1/snapshot/karita  <span style=color:#75715e># foo の存在確認</span>
Desktop  dlang  Documents  Downloads  foo  Music  Pictures  Public  snap  Templates  tool  Videos</code></pre></div></div><p>こんな感じで、subvolume直下の <code>.snapshots</code> ディレクトリ以下の番号付きのバックアップディレクトリがある体で、手軽にコピーしたり検索したりできます。ただしsnapshotからファイル削除するときなどは、書き込み可能にセット <code>btrfs property set &lt;file> ro false</code> するなど安全に振ってるところはあります。</p><h3 id=headline-7>起動が遅いとき</h3><p>最初、btrfsにしたせいで起動が遅いのかなと思ったのですが、 <code>systemd-analyze blame</code> という神コマンドで片っ端から遅いスタートアップ時のプロセスをオフにして1/100にまで高速化できました。私の環境では <code>NetworkManager-wait-online.service</code> が最も遅かったです。この辺もやはり<a href=https://wiki.archlinux.jp/index.php/%E3%83%96%E3%83%BC%E3%83%88%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E5%90%91%E4%B8%8A>Arch Wikiに良い記事</a>があり参考にします。</p><h3 id=headline-8>Linux上のVBoxからWindows 10起動</h3><p>前にもやったので簡単にできると思ってたら、別々のNVMeにインストールしていたので追加の設定が必要でした。ちなみにNVMeだけどSATAとします。ここでは最初の項目がWindows 10の入ってるNVMeの仮想ディスク (vmdk) で、二個目がLinuxが入っている方です。これらはハードウェアと同じコントローラ接続構成にしないとWindowsの軟弱なUEFIだかGPTの設定が壊れてると勘違いしてしまいました。</p><p><img src=vbox.png alt=vbox.png title=vbox.png></p><p>それぞれの vmdk は <code>/dev/nvme*</code> など実在のデバイス名を確認しながら、こんな感じで作ります。パーティションとかはつけずそっくり作ります。</p><div class="src src-bash"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>VBoxManage internalcommands createrawvmdk -filename <span style=color:#e6db74>&#34;nvme1n1.vmdk&#34;</span> -rawdisk /dev/nvme1n1</code></pre></div></div><p>まじめにディスクの指定を厳格にしたければ <code>/dev/disk/by-id/nvme-*</code> とかを rawdisk の引数とするのもいいと思います。</p><h3 id=headline-9>おわりに</h3><p>いまのところスナップショット・コピーオンライト以外の恩恵を受けていないので、今年こそはハードの増設などを視野にいれたNASを組んでみます。その際にあらためてZFSとの比較などもできれば。</p><p>あと今回から、このブログを <a href=https://github.com/ShigekiKarita/log/blob/master/.github/workflows/build.yml>GitHub Actions</a> で deploy してみました。いままで何だかんだ30-60秒くらいTravisではかかっていたし、たまにdeploy失敗するのでしんどかったのですが、GAでは10-15秒くらいで公開できるようです。認証のためにsecret token, sshとgithub tokenという幾つか方法があるのですが、github tokenはactionsの特権で何も設定する必要がなくて良いです。</p><p><a href=https://github.com/peaceiris/actions-gh-pages><a href=https://github.com/peaceiris/actions-gh-pages>https://github.com/peaceiris/actions-gh-pages</a></a></p></div><div class="post__tags tags clearfix"><svg class="tags__icon icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/log/tags/linux/ rel=tag>Linux</a></li><li class=tags__item><a class="tags__link btn" href=/log/tags/btrfs/ rel=tag>btrfs</a></li></ul></div></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Shigeki Karita avatar" src=/log/img/avatar.jpg class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name></span></div><div class=authorbox__description>D言語と日々の研究について雑記</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=/log/posts/vst3-test-tips/ rel=prev><span class=post-nav__caption>«&#8201;</span><p class=post-nav__post-title>VST3開発TIPS テスト編</p></a></div><div class="post-nav__item post-nav__item--next"><a class=post-nav__link href=/log/posts/uniqlo/ rel=next><span class=post-nav__caption>&#8201;»</span><p class=post-nav__post-title>衣服を統一する</p></a></div></nav></div></div><script type=text/x-mathjax-config>
 MathJax.Hub.Config({
     tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
     TeX: { equationNumbers: {autoNumber: "AMS"} }
 });
 MathJax.Hub.Config({
     tex2jax: {
         inlineMath: [['$','$'], ['\\(','\\)']],
         displayMath: [['$$','$$'], ['\[','\]']],
         processEscapes: true,
         processEnvironments: true,
         skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
         TeX: { equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js"] }
     }
 });

</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-6633457078111023",enable_page_level_ads:true});</script></div></body></html>